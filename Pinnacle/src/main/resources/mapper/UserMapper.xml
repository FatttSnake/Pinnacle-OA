<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cfive.pinnacle.mapper.UserMapper">

    <select id="getAll" resultMap="userMap">
        select t_user.id            as user_id,
               t_user.username      as user_username,
               t_user.department_id as user_department,
               t_user.enable        as user_enable,
               t_user.deleted       as user_deleted,
               t_user.version       as user_version,
               tr.id                as role_id,
               tr.name              as role_name,
               tr.deleted           as role_deleted,
               tr.version           as role_version,
               tg.id                as group_id,
               tg.name              as group_name,
               tg.deleted           as group_deleted,
               tg.version           as group_version
        from t_user
                 left join (select * from t_user_role where deleted = 0) as tur on t_user.id = tur.user_id
                 left join (select * from t_role where deleted = 0) as tr on tr.id = tur.role_id
                 left join (select * from t_user_group where deleted = 0) as tug on t_user.id = tug.user_id
                 left join (select * from t_group where deleted = 0) as tg on tg.id = tug.group_id
        where t_user.deleted = 0;
    </select>
    <select id="getOneById" resultMap="userMap">
        select t_user.id            as user_id,
               t_user.username      as user_username,
               t_user.department_id as user_department,
               t_user.enable        as user_enable,
               t_user.deleted       as user_deleted,
               t_user.version       as user_version,
               tr.id                as role_id,
               tr.name              as role_name,
               tr.deleted           as role_deleted,
               tr.version           as role_version,
               tg.id                as group_id,
               tg.name              as group_name,
               tg.deleted           as group_deleted,
               tg.version           as group_version
        from t_user
                 left join (select * from t_user_role where deleted = 0) as tur on t_user.id = tur.user_id
                 left join (select * from t_role where deleted = 0) as tr on tr.id = tur.role_id
                 left join (select * from t_user_group where deleted = 0) as tug on t_user.id = tug.user_id
                 left join (select * from t_group where deleted = 0) as tg on tg.id = tug.group_id
        where t_user.deleted = 0
          and t_user.id = #{id};
    </select>
    <select id="getOneWithPowerByUsername" resultMap="userWithPowerMap">
        select distinct t_user.id            as user_id,
                        t_user.username      as user_username,
                        t_user.passwd        as user_passwd,
                        t_user.department_id as user_department,
                        t_user.enable        as user_enable,
                        t_user.deleted       as user_deleted,
                        t_user.version       as user_version,
                        tm.id                as menu_id,
                        tm.name              as menu_name,
                        tm.url               as menu_url,
                        tm.power_id          as menu_powerId,
                        tm.parent_id         as menu_parentId,
                        te.id                as element_id,
                        te.name              as element_name,
                        te.power_id          as element_powerId,
                        te.menu_id           as element_menuId,
                        t.id                 as operation_id,
                        t.name               as operation_name,
                        t.code               as operation_code,
                        t.power_id           as operation_powerId,
                        t.element_id         as operation_elementId,
                        t.parent_id          as operation_parentId
        from t_user
                 left join (select * from t_user_group where deleted = 0) as tug on t_user.id = tug.user_id
                 left join (select * from t_group where deleted = 0) as tg on tg.id = tug.group_id
                 left join (select * from t_role_group where deleted = 0) as trg on tg.id = trg.group_id
                 left join (select * from t_user_role where deleted = 0) as tur on t_user.id = tur.user_id
                 left join (select * from t_role where deleted = 0) as tr on tr.id = trg.role_id or tr.id = tur.role_id
                 left join (select * from t_power_role where deleted = 0) as tpr on tpr.role_id = tr.id
                 left join t_power as tp on tp.id = tpr.power_id
                 left join t_menu tm on tp.id = tm.power_id
                 left join t_element te on tp.id = te.power_id
                 left join t_operation t on tp.id = t.power_id
        where t_user.deleted = 0
          and t_user.username = #{username};
    </select>

    <resultMap id="userMap" type="user">
        <id property="id" column="user_id"/>
        <result property="username" column="user_username"/>
        <result property="departmentId" column="user_department"/>
        <result property="enable" column="user_enable"/>
        <result property="deleted" column="user_deleted"/>
        <result property="version" column="user_version"/>
        <collection property="roles" ofType="role">
            <id property="id" column="role_id"/>
            <result property="name" column="role_name"/>
            <result property="deleted" column="role_deleted"/>
            <result property="version" column="role_version"/>
        </collection>
        <collection property="groups" ofType="group">
            <id property="id" column="group_id"/>
            <result property="name" column="group_name"/>
            <result property="deleted" column="group_deleted"/>
            <result property="version" column="group_version"/>
        </collection>
    </resultMap>

    <resultMap id="userWithPowerMap" type="user">
        <id property="id" column="user_id"/>
        <result property="username" column="user_username"/>
        <result property="passwd" column="user_passwd"/>
        <result property="departmentId" column="user_departmentId"/>
        <result property="enable" column="user_enable"/>
        <result property="deleted" column="user_deleted"/>
        <result property="version" column="user_version"/>
        <collection property="menus" ofType="menu">
            <id property="id" column="menu_id"/>
            <result property="name" column="menu_name"/>
            <result property="url" column="menu_url"/>
            <result property="powerId" column="menu_powerId"/>
            <result property="parentId" column="menu_parentId"/>
        </collection>
        <collection property="elements" ofType="element">
            <id property="id" column="element_id"/>
            <result property="name" column="element_name"/>
            <result property="powerId" column="element_powerId"/>
            <result property="menuId" column="element_menuId"/>
        </collection>
        <collection property="operations" ofType="operation">
            <id property="id" column="operation_id"/>
            <result property="name" column="operation_name"/>
            <result property="code" column="operation_code"/>
            <result property="powerId" column="operation_powerId"/>
            <result property="elementId" column="operation_elementId"/>
            <result property="parentId" column="operation_parentId"/>
        </collection>
    </resultMap>
</mapper>
